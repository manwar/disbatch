#!/usr/bin/env perl

# USAGE: ./disbatchd --host localhost --db disbatch_test --queue abcd1234 --ignore 1234abcd

use 5.12.0;
use warnings;

use lib 'lib';	# FIXME: for testing

use Data::Dumper;
use Disbatch;
use Getopt::Long;
use Try::Tiny::Retry;
#use Safe::Isa;

$SIG{HUP}  = sub { exit 129 };	# 1
$SIG{INT}  = sub { exit 130 };	# 2	ctrl-c
$SIG{QUIT} = sub { exit 131 };	# 3	ctrl-\
#$SIG{PIPE} = 'IGNORE';		# 13
$SIG{TERM} = sub { exit 143 };	# 15	kill
$SIG{CHLD} = 'IGNORE';		# 20	Zombies are bad, m'kay?

my $config_file = '/etc/disbatch/disbatch.json';

GetOptions('config=s' => \$config_file);

my $disbatch = Disbatch->new(class => 'Disbatch', config_file => $config_file);
$disbatch->load_config;
my $logger = $disbatch->logger('daemon');
$logger->info("Starting disbatch daemon");

$disbatch->ensure_indexes;
$disbatch->validate_plugins;

do {
    $disbatch->orphaned_tasks;
    $disbatch->process_queues;
    $disbatch->update_node_status;
    $disbatch->load_config;
} while sleep 1;

END {
    $logger->info("Exit code $?");
    if ($disbatch->{claimed_task}) {
        my $unclaimed = $disbatch->unclaim_task($disbatch->{claimed_task}{_id});
        if (defined $unclaimed) {
            $logger->warn("Unclaimed task $unclaimed->{_id}");
        } else {
            $logger->error("Task $unclaimed->{_id} not unclaimed!");
        }
    }
}
